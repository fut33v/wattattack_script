# codex_context.md

## Проект
WattAttack Bot Suite

## Описание
Телеграм-бот и вспомогательные утилиты для автоматизации работы с аккаунтами WattAttack: применение клиентских данных к профилям спортсменов, загрузка тренировок в библиотеку из файлов ZWO с расчётом метрик, поиск и управление клиентами, рассылка FIT-файлов о новых тренировках, поддержка импорта CSV и централизованное управление администраторами.

## Стек технологий
- Python 3.11+
- python-telegram-bot
- requests
- psycopg2-binary / PostgreSQL
- Docker / docker-compose
- asyncio, logging

## Цель проекта
- Управлять аккаунтами WattAttack через Телеграм (просмотр/обновление профилей, загрузка фит-файлов).
- Хранить клиентские данные (вес, рост, FTP, цели) и быстро применять их к нужным аккаунтам.
- Обеспечить централизованный импорт клиентов из CSV и контроль списка администраторов.
- Уведомлять администраторов о новых активностях с автоматической отправкой FIT-файлов.

## Основные модули / компоненты
- `wattattackbot/` – основной бот (команды, inline-навигация, поиск клиентов, управление администраторами).
- `wattattackscheduler/` – пакет со скедулером и нотификатором новых тренировок.
- `wattattack_activities.py` – обёртка над API WattAttack (login, профили, активности, загрузка тренировок).
- `wattattack_workouts.py` – парсер ZWO, нормализация данных, построение графиков/метрик и сборка payload для `/workouts/user-create`.
- `scripts/load_clients.py` – импорт клиентов из CSV в БД.
- `repositories/client_repository.py` – операции с таблицей клиентов (листинг, поиск, получение).
- `repositories/admin_repository.py` – хранение и управление администраторами.
- `repositories/bikes_repository.py` / `repositories/trainers_repository.py` – учёт велосипедов и станков.
- `repositories/db_utils.py` – подключение к PostgreSQL.
- `scripts/load_bikes.py` / `scripts/load_trainers.py` – импорт инвентаря из CSV в БД.
- `scripts/wattattack_profile_set.py` / `scripts/wattattack_profile_debug.py` – вспомогательные CLI-скрипты.

## Ключевые структуры данных
- Таблица `clients` (PostgreSQL) – хранение данных клиента: имя, фамилия, вес, рост, FTP, пол, дополнительные поля.
- Таблица `admins` (PostgreSQL) – хранение Telegram ID/username администраторов.
- Класс `WattAttackClient` – авторизация и запросы к API WattAttack (`/auth/login`, `/athlete`, `/user/update`, `/activities`, `/auth/check`, `/workouts/user-create`).
- Структура ZWO-тренировки (`wattattack_workouts.parse_zwo_workout`) – словарь с сегментами, метаданными, рассчитанными графиками и метриками.
- Клиентские записи в боте (`client_record`) – словари с данными клиента, применяемыми к аккаунту.

## Архитектура
- Бот реализован как асинхронный Telegram-процесс (python-telegram-bot). Потоки данных: команда/сообщение → обработчик команды → репозиторий/DB → API WattAttack → ответ пользователю. Для `/uploadworkout` дополнительно выполняется парсинг ZWO → расчёт графиков/метрик → публикация через `WattAttackClient.upload_workout`.
- Нотификатор: планировщик (`wattattackscheduler/scheduler.py`) циклически вызывает `wattattackscheduler/notifier.py`, который обращается к API WattAttack и БД, затем отправляет сообщения через Telegram API.
- Данные хранятся в PostgreSQL; импорт CSV обновляет таблицы; бот/нотификатор читают их через репозитории.

## Стиль кода и конвенции
- PEP 8 (snake_case, 4 пробела отступа).
- Логирование через стандартный модуль `logging` (INFO/ERROR).
- Все команды проверяют права администратора перед обработкой.
- Команды и ответы бота формируются на русском языке.
- CSV импорт ожидает колонки из обновлённого опроса (Имя, Фамилия, ПОЛ, вес, рост, FTP и т.д.).

## Текущие задачи
- Автоматически заполнять дату рождения `2000-01-01`, если отсутствует, чтобы избежать ошибок API.
- Поддерживать корректный импорт CSV через `/uploadclients`, включая опцию `truncate`.
- Поддерживать загрузку ZWO через `/uploadworkout`, включая обработку ошибок парсера и откликов `/workouts/user-create`.
- Следить за целостностью данных клиентов и администраторов в БД.

## Инструкция для Codex
- Этот файл используется как контекст при старте новых чатов.
- Codex должен учитывать всё из этого файла перед генерацией кода.
- Не изменять существующий код без анализа контекста.
- Использовать стиль и архитектуру, описанные выше.
