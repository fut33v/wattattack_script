# codex_context.md

## Проект
WattAttack Bot Suite

## Описание
Телеграм-бот и вспомогательные утилиты для автоматизации работы с аккаунтами WattAttack: применение клиентских данных к профилям спортсменов, поиск и управление клиентами, рассылка FIT-файлов о новых тренировках, поддержка импорта CSV и централизованное управление администраторами.

## Стек технологий
- Python 3.11+
- python-telegram-bot
- requests
- psycopg2-binary / PostgreSQL
- Docker / docker-compose
- asyncio, logging

## Цель проекта
- Управлять аккаунтами WattAttack через Телеграм (просмотр/обновление профилей, загрузка фит-файлов).
- Хранить клиентские данные (вес, рост, FTP, цели) и быстро применять их к нужным аккаунтам.
- Обеспечить централизованный импорт клиентов из CSV и контроль списка администраторов.
- Уведомлять администраторов о новых активностях с автоматической отправкой FIT-файлов.

## Основные модули / компоненты
- `wattattack_bot.py` – основной бот (команды, inline-навигация, поиск клиентов, управление администраторами).
- `wattattack_notifier.py` – периодический нотификатор новых тренировок.
- `wattattack_activities.py` – обёртка над API WattAttack.
- `load_clients.py` – импорт клиентов из CSV в БД.
- `client_repository.py` – операции с таблицей клиентов (листинг, поиск, получение).
- `admin_repository.py` – хранение и управление администраторами.
- `db_utils.py` – подключение к PostgreSQL.
- `wattattack_profile_set.py` / `wattattack_profile_debug.py` – вспомогательные CLI-скрипты.

## Ключевые структуры данных
- Таблица `clients` (PostgreSQL) – хранение данных клиента: имя, фамилия, вес, рост, FTP, пол, дополнительные поля.
- Таблица `admins` (PostgreSQL) – хранение Telegram ID/username администраторов.
- Класс `WattAttackClient` – авторизация и запросы к API WattAttack (`/auth/login`, `/athlete`, `/user/update`, `/activities`, `/auth/check`).
- Клиентские записи в боте (`client_record`) – словари с данными клиента, применяемыми к аккаунту.

## Архитектура
- Бот реализован как асинхронный Telegram-процесс (python-telegram-bot). Потоки данных: команда/сообщение → обработчик команды → репозиторий/DB → API WattAttack → ответ пользователю.
- Нотификатор: планировщик (`wattattack_scheduler.py`) циклически вызывает `wattattack_notifier.py`, который обращается к API WattAttack и БД, затем отправляет сообщения через Telegram API.
- Данные хранятся в PostgreSQL; импорт CSV обновляет таблицы; бот/нотификатор читают их через репозитории.

## Стиль кода и конвенции
- PEP 8 (snake_case, 4 пробела отступа).
- Логирование через стандартный модуль `logging` (INFO/ERROR).
- Все команды проверяют права администратора перед обработкой.
- Команды и ответы бота формируются на русском языке.
- CSV импорт ожидает колонки из обновлённого опроса (Имя, Фамилия, ПОЛ, вес, рост, FTP и т.д.).

## Текущие задачи
- Автоматически заполнять дату рождения `2000-01-01`, если отсутствует, чтобы избежать ошибок API.
- Поддерживать корректный импорт CSV через `/uploadclients`, включая опцию `truncate`.
- Отлаживать обновление профилей WattAttack (следить за ответами API, корректировать payload при необходимости).
- Следить за целостностью данных клиентов и администраторов в БД.

## Инструкция для Codex
- Этот файл используется как контекст при старте новых чатов.
- Codex должен учитывать всё из этого файла перед генерацией кода.
- Не изменять существующий код без анализа контекста.
- Использовать стиль и архитектуру, описанные выше.
