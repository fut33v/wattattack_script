
services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${DB_NAME:-wattattack}
      POSTGRES_USER: ${DB_USER:-wattattack}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-wattattack}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  adminbot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    command: ["python", "-m", "adminbot"]
    env_file: .env
    volumes:
      - ./accounts.json:/app/accounts.json:ro
    depends_on:
      - db
    restart: unless-stopped

  fitbot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    command: ["python", "-m", "krutilkafitbot"]
    env_file: .env
    volumes:
      - ./accounts.json:/app/accounts.json:ro
    depends_on:
      - db
    restart: unless-stopped

  clientbot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    command: ["python", "-m", "clientbot.main"]
    env_file: .env
    restart: unless-stopped
  
  vkbot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    command: ["python", "-m", "vkbot"]
    env_file: .env
    restart: unless-stopped

  scheduler:
    build:
      context: .
      dockerfile: Dockerfile.bot
    command:
      [
        "python",
        "-m",
        "scheduler",
        "--interval",
        "${WATTATTACK_INTERVAL_SECONDS:-300}",
        "--notifier-args",
        "--accounts",
        "/app/accounts.json",
        "--state",
        "/app/notifier_state/state.json"
      ]
    env_file: .env
    volumes:
      - ./accounts.json:/app/accounts.json:ro
      - ./notifier_state:/app/notifier_state
      - ./data/fit_files:/app/data/fit_files
    depends_on:
      - db
    restart: unless-stopped

  webapp:
    build: .
    command: ["uvicorn", "webapp.main:app", "--host", "0.0.0.0", "--port", "3002"]
    env_file: .env
    depends_on:
      - db
    ports:
      - "3002:3002"
    volumes:
      - ./data/fit_files:/app/data/fit_files
    restart: unless-stopped

  backup:
    build:
      context: .
      dockerfile: docker/backup/Dockerfile
    environment:
      DATABASE_URL: ${DATABASE_URL:-}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-wattattack}
      DB_USER: ${DB_USER:-wattattack}
      DB_PASSWORD: ${DB_PASSWORD:-wattattack}
      BACKUP_TG_BOT_TOKEN: ${BACKUP_TG_BOT_TOKEN:-}
      KRUTILKAFIT_BOT_TOKEN: ${KRUTILKAFIT_BOT_TOKEN:-}
      BACKUP_TG_CHAT_ID: ${BACKUP_TG_CHAT_ID:-}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-14}
      BACKUP_TG_CAPTION: ${BACKUP_TG_CAPTION:-Fitbot DB backup}
      BACKUP_CRON_SCHEDULE: ${BACKUP_CRON_SCHEDULE:-0 3 * * *}
      TZ: ${TZ:-Europe/Moscow}
    depends_on:
      - db
    volumes:
      - ./backups:/backups
    restart: unless-stopped

volumes:
  postgres_data:
