# Набор ботов WattAttack

## Обзор
Репозиторий содержит несколько Telegram-ботов и утилиты для управления аккаунтами WattAttack, а также веб-приложение «Крутилка» для администраторов. Боты автоматизируют применение данных клиента (из БД PostgreSQL) к профилям WattAttack, скачивают FIT-файлы новых тренировок и по запросу показывают сведения об аккаунтах. Скрипты помогают импортировать клиентов из CSV и обновлять профили через API WattAttack.

## Компоненты
- **adminbot/** – Telegram-бот, который управляет профилями WattAttack, клиентами и инвентарём:
  - `/start`, `/help` – навигация и подсказки.
  - `/wizard` – ближайшие слоты расписания с быстрой массовой посадкой на аккаунты.
  - `/account <id>` – показать текущие данные профиля WattAttack.
  - `/combinate` — подбор велосипеда/станка по параметрам клиента.
  - `/bikes [поиск]` – список доступных велосипедов (поддерживает поисковый запрос).
  - `/client <query>` – поиск клиентов по имени/фамилии.
  - `/setclient <id>` – применить данные выбранного клиента к аккаунту WattAttack.
  - `/newclient` – создать запись клиента прямо из Telegram.
  - `/layout` – показать текущую расстановку велосипедов по станкам.
  - `/uploadclients [truncate]` – импорт клиентов из CSV (ответом или пересылкой); можно обнулить таблицу.
  - `/uploadbikes [truncate]` – импорт велосипедов из CSV (ответом или пересылкой); можно обнулить таблицу.
  - `/uploadstands [truncate]` – импорт станков из CSV (ответом или пересылкой); можно обнулить таблицу.
  - `/uploadworkout [all|account…]` – загрузка тренировки ZWO в одну или несколько библиотек WattAttack (парсинг + метрики).
  - `/admins`, `/addadmin`, `/removeadmin` – управление администраторами бота.
  - Инлайн-меню для выбора аккаунта/клиента и быстрый текстовый поиск (только для админов).
- **krutilkafitbot/** – Telegram-бот для скачивания активностей:
  - `/start`, `/help` – показать список аккаунтов и подсказки.
  - `/recent <n>` – получить последние тренировки выбранного аккаунта.
  - `/latest` – скачать последнюю активность каждого аккаунта.
- **scheduler/** – цикл планировщика и CLI-уведомитель: следит за новыми активностями в WattAttack, автоматически сопоставляет их с расписанием и рассылает FIT-файлы с метаданными администраторам.
- **wattattack_activities.py** – обёртка над API WattAttack (`/auth/login`, `/activities`, `/athlete/update`, `/user/update`, `/auth/check`, `/workouts/user-create`).
- **wattattack_workouts.py** – парсер ZWO, очистка, расчёт метрик/графиков и сборка payload для загрузки в библиотеку.
- **scripts/load_clients.py** – CLI-лоадер клиентов из CSV в PostgreSQL (опция `--truncate`).
- **scripts/load_bikes.py** – CLI-лоадер велосипедов из CSV (опция `--truncate`).
- **scripts/load_trainers.py** – CLI-лоадер станков из CSV (опция `--truncate`).
- **repositories/admin_repository.py** – управление администраторами (создание таблицы, наполнение из env, CRUD-хелперы).
- **repositories/client_repository.py** – помощники для доступа к клиентам (список, поиск, получение по id).
- **repositories/bikes_repository.py** – помощники для инвентаря велосипедов (создание, поиск/листинг).
- **repositories/trainers_repository.py** – помощники для инвентаря станков (создание, поиск/листинг).
- **repositories/db_utils.py** – хелперы подключения к PostgreSQL.
- **scripts/wattattack_profile_set.py** – CLI для обновления полей профиля WattAttack (имя, вес, FTP и т.д.).
- **clientbot/** – Telegram-бот для клиентов: авторизация по фамилии и привязка Telegram-пользователей к клиентским записям.
- **webapp/frontend/** – SPA «Крутилка» на React + Vite с React Query и современным UI для работы с API.
- **webapp/** – FastAPI-бэкенд (API + Telegram login) и фронтенд React/Vite для управления клиентами, велосипедами, тренажёрами, связками и администраторами.

## Возможности
- **Только для админов**: все команды, колбэки и текстовые хендлеры требуют статуса админа. Админы хранятся в БД; `/addadmin` и `/removeadmin` меняют список на лету. Начальный список берётся из `TELEGRAM_ADMIN_IDS`.
- **Управление клиентами**: CSV импорт нормализует имя, пол, вес, рост, FTP, педали, цели и т.д. `/client` и обычный текст ищут по клиентам; `/setclient` применяет их данные к аккаунтам (с обязательными полями `birthDate` и полом). Карточка клиента показывает подобранные велосипеды и станки (учитываются рост, оси, кассеты). `/stands` ведёт учёт станков и даёт редактировать оси/кассеты, `/bikes` показывает парк велосипедов и позволяет менять диапазон роста, `/layout` отображает расстановку. `/account` получает актуальные данные профиля WattAttack.
- **Загрузка тренировок**: `/uploadworkout` парсит ZWO на сервере, строит графики и метрики мощности (IF, NP, TSS, разбивка по зонам) с учётом FTP спортсмена и загружает тренировку в выбранные аккаунты WattAttack.
- **Уведомления об активностях**: notifier и krutilkafitbot отправляют FIT и метаданные при появлении новых тренировок. Список админов берётся из БД.
- **Готово к Docker**: `docker-compose.yml` поднимает сервис бота (`bot`), планировщик (`scheduler`) и Postgres (`db`, порт 55432 на хосте). Том `postgres_data` хранит состояние БД.

## Гайд для контрибьюторов
Смотрите `AGENTS.md` для правил по структуре, процессам и ожиданиям при ревью.

## Настройка
1. Установите зависимости бэкенда: `pip install -r requirements.txt` (Python 3.11+).
2. Установите зависимости фронтенда: `cd webapp/frontend && npm install` (Node.js 18+), затем вернитесь в корень `cd ../..`.
3. Скопируйте `.env.example` в `.env` и задайте переменные:
   - `TELEGRAM_BOT_TOKEN` для adminbot, опционально `TELEGRAM_ADMIN_IDS` как сид админов.
   - `KRUTILKAFIT_BOT_TOKEN` — отдельный бот для скачивания активностей (если не задан, используется `TELEGRAM_BOT_TOKEN`).
   - `KRUTILKAVN_BOT_TOKEN` — бот-приветствие (можно переопределить текст `KRUTILKAVN_GREETING`).
   - `DEV_BUILD` — при `1`/`true` веб использует чёрный фавикон `img/logo_black.png` для дев-сборки.
   - `WATTATTACK_ACCOUNTS_FILE` — JSON с email/password/base_url по аккаунтам и опциональными `stand_ids` для автопривязки.
   - `WATTATTACK_LOCAL_TZ` (по умолчанию `Europe/Moscow`) — таймзона для scheduler’а и ботов.
   - `WATTATTACK_ASSIGN_ENABLED` — включить автозапись клиентов в аккаунты (по умолчанию только уведомления).
   - `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`.
   - Таймауты/размеры страниц при необходимости (см. `.env.example`).
   - `TELEGRAM_LOGIN_BOT_USERNAME` — username логин-бота без `@` (используется для виджета авторизации).
   - `TELEGRAM_LOGIN_BOT_TOKEN` — токен логин-бота (по умолчанию `KRUTILKAVN_BOT_TOKEN`, затем `TELEGRAM_BOT_TOKEN`).
   - `WEBAPP_SECRET_KEY` — случайная строка для подписи cookie-сессий.
   - `WEBAPP_BASE_URL` (опция) — базовый URL приложения (используется в ссылках).
   - `WEBAPP_CLIENTS_PAGE_SIZE` (опция) — размер страницы списка клиентов в вебе (по умолчанию 50).
4. Запуск сервисов:
   - Бэкенд/API: `docker-compose up -d db webapp` (или `uvicorn webapp.main:app --reload`) — отдаёт API и собранную SPA «Крутилка».
   - Фронтенд (dev): `cd webapp/frontend && npm run dev` — Vite поднимет SPA на `http://localhost:5173` и проксирует запросы на `:8000`.
   - Telegram-боты: `docker-compose up -d adminbot fitbot scheduler clientbot`.
   - Прод-образ: `docker-compose up -d db webapp` соберёт фронтенд внутри Dockerfile (Node-стадия).
   - **Быстрый локальный дев без пересборки**: `docker compose -f docker-compose.dev.yml up -d db` чтобы поднять только Postgres, затем запускать сервисы напрямую из кода:
     - Adminbot: `bash scripts/dev_adminbot.sh`
       - Остановить: `bash scripts/stop_adminbot.sh`
     - Fitbot: `bash scripts/dev_fitbot.sh`
     - Clientbot: `bash scripts/dev_clientbot.sh`
     - Scheduler: `bash scripts/dev_scheduler.sh`
     - Webapp (reload): `bash scripts/dev_webapp.sh` (порт по умолчанию 8000)
       - Остановить: `bash scripts/stop_webapp.sh`
   Все скрипты подхватывают `.env`, принудительно выставляют `DB_HOST=localhost:5432` и используют `venv/bin/python`. Adminbot-скрипт перед запуском сам убивает активные `python -m adminbot`, чтобы не ловить конфликт getUpdates.
5. Импорт референсных данных:
   - Клиенты: `python -m scripts.load_clients --truncate` или отправьте CSV через `/uploadclients`.
   - Велосипеды: `python -m scripts.load_bikes --truncate` для загрузки CSV из `data/`.
   - Станки: `python -m scripts.load_trainers --truncate` для импорта инвентаря.
6. Настройка команд в BotFather:
   - Для `adminbot`:
     ```
     start - краткое описание возможностей
     wizard - ближайшие слоты и массовая посадка на аккаунты (пересадка/запись в слот)
     help - подсказать доступные команды
     setclient - применить данные клиента к аккаунту
     account - показать текущие данные аккаунта
     combinate - подобрать велосипеды и станки
     bikes - показать доступные велосипеды
     layout - показать текущую расстановку велосипедов
     stands - показать доступные станки
     client - найти клиента по БД
     newclient - создать нового клиента
     events - создать заезд или гонку
     uploadclients - загрузить CSV (интерактивный выбор перезаписи/обновления + dry-run)
     downloadclients - выгрузить клиентов в CSV
     uploadbikes - загрузить CSV велосипедов
     uploadstands - загрузить CSV станков
     uploadworkout - загрузить тренировку ZWO
     admins - список администраторов
     addadmin - добавить администратора
     removeadmin - удалить администратора
     ```
  - Для `krutilkafitbot`:
     ```
     start - показать список аккаунтов
     help - подсказать доступные команды
     recent - последние N активностей для аккаунта
     latest - последняя активность каждого аккаунта
     ```
  - Для `clientbot`:
    ```
    start - привязать Telegram к анкете или открыть меню редактирования данных
    help - подсказать доступные команды
    book - забронировать свободный слот
    mybookings - показать будущие записи
    history - показать историю посещений
    cancel - отменить текущий ввод или бронирование
    strava - подключить или отключить синхронизацию Strava
    ```

## Примечания по использованию
- **Администраторы**: только админы могут вызывать команды или жать инлайн-кнопки. Неадмины получают “Недостаточно прав”.
- **Привязка клиента**: `clientbot` хранит выбранного клиента в таблице `client_links` (создаётся автоматически). Пользователь может снова пройти авторизацию и выбрать другую запись; привязка вступает в силу после подтверждения админом.
- **Онбординг клиентов**: если клиент не найден по фамилии или выбрано «Создать новую запись», бот проведёт через мини-анкету (имя, фамилия, вес, рост, пол, FTP, педали, цель) и создаст запись; имя, фамилия, вес, рост — обязательные, FTP по умолчанию 150, пол выбирается кнопками «М/Ж», педали из фиксированного списка, необязательные поля можно пропустить кнопкой «ОК».

## Веб-админка (SPA «Крутилка»)
- **Авторизация** через Telegram Login виджет. После входа бэкенд ставит cookie-сессию, SPA работает через REST API (`/api/*`).
- **API-эндпоинты**: `/api/clients`, `/api/bikes`, `/api/trainers`, `/api/client-links`, `/api/admins`, `/api/summary`, `/api/session`.
- **Разработка**: запускайте фронтенд (`npm run dev`) и бэкенд (`uvicorn webapp.main:app --reload`) параллельно; Vite проксирует `/api`, `/auth`, `/logout` на порт 8000.
- **Production**: `docker-compose up webapp` соберёт React-приложение «Крутилка», положит статику в `webapp/frontend/dist` и отдаст её через FastAPI (`/app/*`).
- **Client CSV**: столбцы должны совпадать с маппингом `scripts/load_clients.py` (например, “Имя”, “Фамилия”, “Ваш пол”, “Ваш вес” и т.д.). `/uploadclients` предлагает режим (обновление, перезапись, dry-run); после выбора отправьте CSV как документ. `/downloadclients` выгружает в том же формате.
- **Инвентарь велосипедов/станков**: CSV для велосипедов должен соответствовать `scripts/load_bikes.py` (ID, название, владелец, размер, рост от/до, передачи, эксцентрик/ось, кассета). CSV для станков — `scripts/load_trainers.py` (код, модель, отображаемое имя, хозяин, оси, кассета, комментарий). Используйте `/bikes <поиск>` и `/stands <поиск>`; у станков можно менять оси/кассету. Карточка клиента показывает совместимые велосипеды и станки.
- **Загрузка CSV**: `/uploadclients`, `/uploadbikes`, `/uploadstands` принимают CSV документом (пересылкой/ответом); для клиентов и расписания режим задаётся кнопками. `/uploadschedule` принимает XLSX, поддерживает dry-run/keep и выводит отчёт.
- **Редактирование инвентаря**: `/bikes` и `/stands` показывают списки с кнопками для правок роста велосипедов и параметров станков прямо в Telegram.
- **Обновление профиля**: WattAttack требует `birthDate` и пол; если нет, бот ставит `2000-01-01`. Логи включают payload и ответ для прозрачности.
- **Notifier**: использует админов из таблицы `admins`; если список пуст, на старте в лог пишется ошибка.
- **Безопасность**: `.env` и `accounts.json` в .gitignore; храните секреты отдельно. Доступ к PostgreSQL задаётся через переменные окружения.

### Управление расписанием
- Раздел `Расписание` в SPA имеет два режима: обзор (`/app/schedule`) и редактор (`/app/schedule/manage`). Обзор открывается без бокового меню, занимает весь экран и показывает текущую неделю столбцами по дням. Переключение недель — стрелками в заголовке.
- В карточках дней видно, сколько слотов свободно/занято; дни и отдельные слоты сворачиваются по клику, поэтому даже плотная неделя остаётся компактной. Состояние свёртки сохраняется при смене недели.
- В редакторе есть действия `Удалить неделю`, `Заполнить по шаблону`, копирование и синхронизация станков. Удаление требует подтверждения и чистит все слоты/брони выбранной недели.
- Инструкторы управляются в разделе `Инструкторы`: можно добавить тренера по имени или удалить запись. Эти данные используются при создании слота в режиме «С инструктором».
- Бэкенд создаёт таблицу инструкторов при запуске и наполняет базовым списком (Евгений Балакин, Илья Фатеев, Кирилл Иванов). Список можно расширять из интерфейса или обновить `DEFAULT_INSTRUCTORS` в `repositories/instructors_repository.py`, после чего приложение подтянет новые значения.

## Утилиты
- `scripts/load_clients.py` – автономный импортёр (CLI). Возвращает количество вставленных/обновлённых строк.
- `scripts/load_bikes.py` – импортёр инвентаря велосипедов (CLI) с опцией truncate.
- `scripts/load_trainers.py` – импортёр инвентаря станков (CLI) с опцией truncate.
- `scripts/wattattack_profile_set.py` – прямое обновление профиля через CLI (требуется авторизация).
- `scripts/wattattack_profile_debug.py` – помощник для сравнения `/api/v1/athlete` и `/cabinet`.

## Что дальше
- Дополнительные проверки/поля персоны, если WattAttack ужесточит требования к профилю.
- Миграции схемы можно будет ввести через отдельный инструмент, если функциональность расширится.
